<!--profile.wxml-->
<view class="profile-page">

  <!-- æœªç™»å½•çŠ¶æ€ -->
  <!-- <view wx:if="{{!isLoggedIn}}" class="profile-section login-section">
    <button class="login-button" bindtap="goToLogin">ç™»å½• / æ³¨å†Œ</button>
  </view> -->


  <view class="state-container" wx:if="{{!isLoggedIn}}">
    <image class="state-image" src="/images/state_login.png" mode="aspectFit"></image>
    <text class="state-text">ç™»å½•åæŸ¥çœ‹æ‚¨çš„æ•°æ®</text>
    <button class="state-button primary" bindtap="goToLogin">å¾®ä¿¡æˆæƒç™»å½•</button>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <block wx:else>
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="profile-section user-info-card">
      <view class="avatar-container">
        <image src="{{userInfo.avatar_url }}" alt="ç”¨æˆ·å¤´åƒ" class="avatar" mode="aspectFill"></image>
      </view>
      <text class="nickname">{{userInfo.nickname || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
      <view class="stats">
        <view class="stat-item">
          <text class="stat-value">{{stats.artworkCount}}</text>
          <text class="stat-label">ä½œå“</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{stats.likesCount}}</text>
          <text class="stat-label">è·èµ</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{stats.credits}}</text>
          <text class="stat-label">ç§¯åˆ†</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œåˆ—è¡¨ -->
    <view class="profile-section action-list">
      <!-- æˆ‘çš„ç§¯åˆ† -->
      <view class="action-item has-arrow" bindtap="goToCredits">
        <view class="item-icon">
          <view class="icon-bg" style="background-color: #ff9500;">
            <!-- æ›¿æ¢ä¸ºä½ çš„ç§¯åˆ†å›¾æ ‡, è¿™é‡Œç”¨æ–‡å­—ä»£æ›¿ -->
            <text class="icon-text">ğŸ’°</text>
          </view>
        </view>
        <text class="item-text">æˆ‘çš„ç§¯åˆ†</text>
      </view>
      
      <!-- ç§¯åˆ†å…‘æ¢ -->
      <view class="action-item" bindtap="showActivateCardModal">
        <view class="item-icon">
          <view class="icon-bg" style="background-color: #5856d6;">
            <text class="icon-text">ğŸŸï¸</text>
          </view>
        </view>
        <text class="item-text">ç§¯åˆ†å…‘æ¢</text>
      </view>
      
      <!-- æˆ‘çš„ä½œå“é›† -->
      <view class="action-item has-arrow" bindtap="goToPortfolio">
        <view class="item-icon">
          <view class="icon-bg" style="background-color: #34c759;">
             <!-- æ›¿æ¢ä¸ºä½ çš„ä½œå“é›†å›¾æ ‡, è¿™é‡Œç”¨æ–‡å­—ä»£æ›¿ -->
            <text class="icon-text">ğŸ–¼ï¸</text>
          </view>
        </view>
        <text class="item-text">æˆ‘çš„ä½œå“é›†</text>
      </view>
      
      <!-- è®¢å•æŸ¥è¯¢ -->
      <view class="action-item has-arrow" bindtap="goToOrders">
        <view class="item-icon">
          <view class="icon-bg" style="background-color: #007aff;">
            <text class="icon-text">ğŸ“‹</text>
          </view>
        </view>
        <text class="item-text">è®¢å•æŸ¥è¯¢</text>
      </view>
    </view>

    <!-- ç§¯åˆ†å•†å“å¡ç‰‡ -->
    <view class="profile-section credits-products-card">
      <view class="section-title">ç§¯åˆ†å……å€¼</view>
      <view class="products-grid">
        <view class="product-item" wx:for="{{products}}" wx:key="id" bindtap="selectProduct" data-id="{{item.id}}">
          <view class="product-content {{selectedProductId === item.id ? 'selected' : ''}}">
            <view class="product-credits">{{item.credits}}ç§¯åˆ†</view>
            <view class="product-price">Â¥{{item.price}}</view>
          </view>
        </view>
      </view>
      <button class="pay-button" bindtap="handlePayment" disabled="{{!selectedProductId || isProcessingPayment}}">{{isProcessingPayment ? 'å¤„ç†ä¸­...' : 'ç«‹å³è´­ä¹°'}}</button>
    </view>

    <!-- é€€å‡ºç™»å½•æŒ‰é’® (ç‹¬ç«‹åŒºå—) -->
    <view class="profile-section logout-section">
      <view class="logout-item" bindtap="handleLogout">
        é€€å‡ºç™»å½•
      </view>
    </view>

  </block>

  <!-- åè®®é“¾æ¥ -->
  <view class="footer">
    <navigator url="/pages/privacy/privacy" class="footer-link">æœåŠ¡åè®®</navigator>
  </view>

  <!-- ç§¯åˆ†å…‘æ¢å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showActivateCardModal}}" bindtap="hideActivateCardModal">
    <view class="modal-container" catchtap="preventBubble">
      <view class="modal-header">
        <text class="modal-title">ç§¯åˆ†å…‘æ¢</text>
        <view class="modal-close" bindtap="hideActivateCardModal">Ã—</view>
      </view>
      <view class="modal-content">
        <view class="card-key-input-container">
          <text class="input-label">è¯·è¾“å…¥å¡å¯†</text>
          <input class="card-key-input" type="text" placeholder="è¯·è¾“å…¥9ä½å¡å¯†" maxlength="9" bindinput="onCardKeyInput" value="{{cardKey}}"/>
        </view>
        <text class="modal-tip">å¡å¯†ä»…èƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿ç®¡</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideActivateCardModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm {{cardKey.length === 9 ? '' : 'disabled'}}" 
                bindtap="activateCardKey" disabled="{{cardKey.length !== 9 || isActivating}}">
          {{isActivating ? 'å…‘æ¢ä¸­...' : 'ç«‹å³å…‘æ¢'}}
        </button>
      </view>
    </view>
  </view>
</view> 